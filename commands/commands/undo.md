# 撤销上次操作

## 命令说明
智能回滚Trae命令执行的最后一次破坏性操作，提供多种恢复选项和安全的回滚机制。

## 使用工具
- `run_command` - 执行git操作和系统命令
- `search_codebase` - 分析变更范围和影响
- `view_files` - 检查文件状态和备份
- `list_dir` - 查找备份文件和恢复点
- `update_file` - 恢复特定文件内容
- `write_to_file` - 重建丢失的文件

## 恢复策略分析

### 阶段1：损害评估
**强制步骤：**
1. 分析最近的操作历史
2. 识别被修改或删除的文件
3. 评估变更的影响范围
4. 检查可用的恢复选项

### 阶段2：恢复方案选择
1. Git历史恢复（如果有提交记录）
2. 项目备份恢复（如果有备份文件）
3. 选择性文件恢复（部分恢复）
4. 重建策略（如果无法直接恢复）

### 阶段3：安全恢复执行
1. 创建当前状态快照
2. 执行选定的恢复方案
3. 验证恢复结果
4. 清理临时文件

## Trae使用示例

```markdown
用户：撤销刚才的重构操作，好像删除了重要文件

助手：我来帮你分析并恢复刚才的重构操作。让我检查可用的恢复选项。

*使用run_command检查git状态*
*使用search_codebase分析最近变更*
*使用list_dir查找备份文件*

## 损害评估结果

### 🔍 检测到的变更
- 删除文件：src/utils/helper.js
- 修改文件：src/components/UserCard.tsx
- 移动文件：src/types/user.ts → src/types/User.ts

### 📋 可用恢复选项

#### 选项1：Git历史恢复 ✅ 推荐
- 状态：可用（未提交的变更）
- 范围：完全恢复到重构前状态
- 风险：低（保留工作目录快照）

#### 选项2：选择性恢复 ✅ 可用
- 状态：可用（部分文件恢复）
- 范围：仅恢复删除的helper.js
- 风险：低（保留其他有用变更）

#### 选项3：备份恢复 ❌ 不可用
- 状态：无备份文件

### 🎯 推荐方案
使用Git历史恢复，因为变更尚未提交，可以安全回滚。

*使用run_command执行git reset*

✅ 恢复完成！所有文件已恢复到重构前状态。
```

## 恢复选项详解

### Git基础恢复
```bash
# 撤销工作目录变更
git checkout -- <file>

# 撤销暂存区变更
git reset HEAD <file>

# 撤销最近提交
git reset --soft HEAD~1

# 完全回滚到指定提交
git reset --hard <commit-hash>
```

### 高级Git恢复
```bash
# 创建恢复分支
git checkout -b recovery-branch

# 恢复特定文件的历史版本
git checkout <commit-hash> -- <file-path>

# 使用git reflog恢复
git reflog
git reset --hard HEAD@{2}

# 恢复删除的分支
git checkout -b recovered-branch <commit-hash>
```

### 文件级恢复
```bash
# 从暂存区恢复文件
git restore <file>

# 从特定提交恢复文件
git restore --source=<commit> <file>

# 恢复删除的文件
git ls-files --deleted | xargs git checkout HEAD --
```

## 智能恢复策略

### 变更类型识别
- **文件删除**：从git历史或备份恢复
- **内容修改**：对比差异，选择性恢复
- **文件移动**：恢复原始位置或保持新位置
- **权限变更**：恢复原始权限设置

### 影响范围分析
```markdown
## 影响分析报告

### 🔴 高风险变更
- 删除核心配置文件
- 修改数据库迁移文件
- 删除重要业务逻辑

### 🟡 中等风险变更
- 修改组件接口
- 重构工具函数
- 更新类型定义

### 🟢 低风险变更
- 代码格式调整
- 注释更新
- 测试文件修改
```

### 依赖关系检查
- **导入依赖**：检查删除文件的引用
- **类型依赖**：验证类型定义的完整性
- **配置依赖**：确保配置文件的一致性
- **测试依赖**：检查测试文件的有效性

## 备份系统集成

### 自动备份检查
```bash
# 检查项目备份目录
ls -la .trae-backups/

# 检查时间戳备份
find . -name "*.backup.*" -type f

# 检查git stash
git stash list
```

### 备份恢复流程
```markdown
## 备份恢复步骤

### 1. 备份发现
- 扫描 `.trae-backups/` 目录
- 检查时间戳匹配的备份
- 验证备份文件完整性

### 2. 备份验证
- 检查备份文件大小
- 验证文件格式正确性
- 确认备份时间合理性

### 3. 选择性恢复
- 列出备份中的文件
- 允许用户选择恢复范围
- 预览恢复后的差异
```

## 安全恢复机制

### 恢复前检查
- [ ] 创建当前状态快照
- [ ] 验证恢复目标的有效性
- [ ] 检查潜在的冲突
- [ ] 确认恢复范围合理

### 恢复过程监控
- [ ] 实时显示恢复进度
- [ ] 记录恢复操作日志
- [ ] 检测恢复过程错误
- [ ] 提供中断恢复选项

### 恢复后验证
- [ ] 验证文件完整性
- [ ] 检查项目可构建性
- [ ] 运行基础测试
- [ ] 确认功能正常

## 恢复场景处理

### 场景1：意外删除文件
```markdown
**问题**：重要文件被误删
**检测**：git status显示deleted文件
**方案**：git checkout HEAD -- <file>
**验证**：文件内容和权限正确
```

### 场景2：错误的批量修改
```markdown
**问题**：批量替换导致代码错误
**检测**：大量文件同时修改
**方案**：git reset --hard HEAD
**验证**：代码恢复到修改前状态
```

### 场景3：配置文件损坏
```markdown
**问题**：配置文件格式错误
**检测**：应用启动失败
**方案**：从备份或模板恢复
**验证**：应用正常启动
```

### 场景4：依赖关系破坏
```markdown
**问题**：重构破坏了模块依赖
**检测**：编译或运行时错误
**方案**：选择性恢复相关文件
**验证**：依赖关系正确，功能正常
```

## 预防措施建议

### 操作前备份
- 重要操作前自动创建快照
- 定期提交工作进度
- 使用分支进行实验性修改
- 保持工作目录整洁

### 风险操作识别
- 批量文件操作
- 大规模重构
- 配置文件修改
- 依赖关系变更

### 最佳实践
- 小步骤迭代修改
- 及时测试验证
- 保持良好的git习惯
- 定期备份重要文件

## 重要提示

⚠️ **安全第一**
- 恢复前始终创建当前状态快照
- 仔细评估恢复操作的影响范围
- 优先选择风险最低的恢复方案
- 恢复后进行充分的验证测试

⚠️ **数据保护**
- 永远不要直接覆盖重要数据
- 保留多个恢复点供选择
- 记录所有恢复操作的详细日志
- 确保团队成员了解恢复状态

⚠️ **学习改进**
- 分析导致问题的根本原因
- 改进工作流程避免类似问题
- 完善备份和恢复机制
- 分享经验教训给团队

⚠️ **限制说明**
- 某些操作可能无法完全恢复
- 恢复操作本身也可能带来风险
- 及时寻求帮助，避免进一步损失
- 保持冷静，系统性地分析问题